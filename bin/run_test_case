#!/bin/bash

#
# Make sure we have all the input we need.
#
while getopts "t:d:f:r:e:" option
do
        case "$option" in
        t) export TEST_CASE="$OPTARG";;
        d) export TEST_DESC="$OPTARG";;
        f) export TEST_FILE="$OPTARG";;
        r) export RESULT_FILE="$OPTARG";;
        e) export ERR_FILE="$OPTARG";;
        esac
done

if 	[ ! "$TEST_CASE" ]   || \
	[ ! "$TEST_DESC" ]   || \
	[ ! "$TEST_FILE" ]   || \
	[ ! "$RESULT_FILE" ] || \
	[ ! "$ERR_FILE" ] 
then
	echo "Syntax: $0 -t <test case> -d <description> -f <test file> -r <result file> -e <error file>"
	exit 1
fi

export TEMP_FILE="${RESULT_FILE}.in_progress"



#
# Function to display the output to the screen, whilst updating the test file.
#
log(){
	echo "$1" | tee -a $RESULT_FILE
}


log ""
log ""
log "TEST CASE  : $TEST_CASE"
log "Description: $TEST_DESC"

x=`(time gaiatest --address localhost:2828 $TEST_FILE > $TEMP_FILE 2>$ERR_FILE) 2>&1 | grep real | awk '{print $2}'`

# Report comments (can be on more than one line).
counter=0
egrep '^==COMMENT' $TEMP_FILE | sed -e 's/^[^ ]* //' | while read line
do
	if [ $counter -eq 0 ]
	then
		counter=1
		str1="Comments   :"
	else
		str1="            "
	fi
	log "$str1 $line"
done

log "Time taken : $x"
log "Passed     : $(egrep '^==PASSED' $TEMP_FILE | sed -e 's/^[^ ]* //')"
log "Failed     : $(egrep '^==FAILED' $TEMP_FILE | sed -e 's/^[^ ]* //')"
log ""
egrep "^==ERROR " $TEMP_FILE | sed -e "s/^[^ ]* //" | while read line
do
	log "    ** ERROR ** $line"
done
log ""

if [ "$(egrep 'ERROR|Error' $ERR_FILE)" ]
then
	log "*******************************************************"
	log "*    NOTE: Uncaught errors were returned by Marionette! "
	log "*"
	cat $ERR_FILE | while read line
	do
		log "*    $line"
	done
	log "*******************************************************"
fi

rm -f $TEMP_FILE
