#!/bin/bash

#
# Some of these variables come from 'run_all_tests' ...
#
export ERR_FILE=${RESULT_DIR}/error_output
export SUM_FILE=${RESULT_DIR}/${TEST_NUM}_summary
export DET_FILE=${RESULT_DIR}/${TEST_NUM}_detail


#
# Run the test using 'gaiatest', ignore STDOUT (because what we want is being
# writtin to a file), but capture STDERR.
#
gaiatest --address localhost:2828 $TEST_FILE > /dev/null 2>$ERR_FILE

#
# Now append any Marionette output to the details file (sometimes it contains
# 'issues' that we don't catch).
#
x=$(grep -i error $ERR_FILE)
if [ "$x" ]
then
	echo "



################################################################################
#
# OUTPUT FROM MARIONETTE ....
# ===========================
#

$(cat $ERR_FILE)
" >> $DET_FILE

fi


#
# Display the summary file.
# If there is an 'error' in the marionette output but we think our tests
# passed, this indicates a possible error with our test code.
#
cat $SUM_FILE | while read line
do
    printf "$line"
    result=$(echo $line | awk '{print $NF}')
    if [ "$result" = "Passed" ]
    then
        x=$(grep -i error $ERR_FILE)
	if [ "$x" ]
	then
	    printf " (NOTE: possible test code error!)"
	fi
    fi
    printf "\n"
done
