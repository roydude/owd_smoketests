#!/bin/bash
export TEST_CASE="$1"
export TEST_DESC="$2"
export TEST_FILE="$3"
export RESULT_FILE="$4"; export RESULT_FILE
export ERR_FILE="$5"
export TEMP_FILE="${RESULT_FILE}.in_progress"

if [ "$TEMP_FILE" = "" ]
then
	echo "Syntax: $0 <test case> <description> <test file> <result file>"
	exit 1
fi

#
# Function to display the output to the screen, whilst updating the test file.
#
log(){
	echo "$1" | tee -a $RESULT_FILE
}

log ""
log ""
log "TEST CASE  : $TEST_CASE"
log "Description: $TEST_DESC"

x=`(time gaiatest --address localhost:2828 $TEST_FILE > $TEMP_FILE 2>$ERR_FILE) 2>&1 | grep real | awk '{print $2}'`

# Report comments (can be on more than one line).
counter=0
egrep '^==COMMENT' $TEMP_FILE | sed -e 's/^[^ ]* //' | while read line
do
	if [ $counter -eq 0 ]
	then
		counter=1
		str1="Comments   :"
	else
		str1="            "
	fi
	log "$str1 $line"
done

log "Time taken : $x"
log "Passed     : $(egrep '^==PASSED' $TEMP_FILE | sed -e 's/^[^ ]* //')"
log "Failed     : $(egrep '^==FAILED' $TEMP_FILE | sed -e 's/^[^ ]* //')"
log ""
egrep "^==ERROR " $TEMP_FILE | sed -e "s/^[^ ]* //" | while read line
do
	log "    ** ERROR ** $line"
done
log ""

if [ "$(egrep 'ERROR|SyntaxError' $ERR_FILE)" ]
then
	log "*******************************************************"
	log "*    NOTE: Uncaught errors were returned by Marionette! "
	log "*"
	cat $ERR_FILE | while read line
	do
		log "*    $line"
	done
	log "*******************************************************"
fi

rm -f $TEMP_FILE
